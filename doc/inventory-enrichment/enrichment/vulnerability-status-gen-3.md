> [Vulnerability Monitoring](../inventory-enrichment-overview.md) > [Inventory Enrichment](inventory-enrichment.md) >
> Vulnerability Status (Gen 3)

# Vulnerability Status (Generation 3.x)

Status files are used to apply assessment information to vulnerabilities in an inventory.
Please also view (and use!) the [JSON Schema](https://www.metaeffekt.com/schema/artifact-analysis/) for editing the YAML
files.

<!-- TOC -->

* [Vulnerability Status (Generation 3.x)](#vulnerability-status-generation-3x)
    * [Assessment files](#assessment-files)
    * [Assessment file properties](#assessment-file-properties)
        * [affects](#affects)
        * [scope](#scope)
        * [active](#active)
        * [title](#title)
        * [cvssV2 / cvssV3 / cvssV4](#cvssv2--cvssv3--cvssv4)
        * [reported / accepted](#reported--accepted)
        * [reviewed](#reviewed)
        * [history](#history)
        * [validation](#validation)
    * [Advisory priority and multiple assessment matching handling](#advisory-priority-and-multiple-assessment-matching-handling)
        * [Status history ordering (compareTo)](#status-history-ordering-compareto)
        * [Which assessment entry is picked in the first place?](#which-assessment-entry-is-picked-in-the-first-place)
    * [Use-Cases / Examples](#use-cases--examples)
        * [EX-1: Applying assessments for individual vulnerabilities](#ex-1-applying-assessments-for-individual-vulnerabilities)
        * [EX-2: CPE / CWE assessments](#ex-2-cpe--cwe-assessments)
        * [EX-3: Global assessments](#ex-3-global-assessments)
        * [EX-4: Automated conditional assessments](#ex-4-automated-conditional-assessments)
        * [EX-5: Inventory Validation](#ex-5-inventory-validation)

<!-- TOC -->

## Assessment files

Assessments are represented by entries in YAML files, where each file can either contain a single assessment entry or
multiple by using a list. The properties that can be used in an assessment file are described in the following
sections.

The assessment format allows for representing a variety of use-cases:

1. Applying assessments for individual vulnerabilities.
2. Generally applying assessments on CPEs/CWEs for an initial assessment that is applied to an entire third party
   software.
3. Applying a global assessment on an entire product inventory.
4. Applying automated assessments based on several factors, like the presence of a patch, text content or a date.

These will be explored in greater detail with proper examples below the properties section.
Here's an example for a list file and a single entry file:

```yaml
- affects:
    cpe:
      - cpe:/a:apache:tomcat
  cvssV3: MAV:A
```

vs.

```yaml
affects:
  cpe:
    - cpe:/a:apache:tomcat
cvssV3: MAV:A
```

## Assessment file properties

### affects

The `affects` section defines on what vulnerabilities to apply the assessment file.
There are several different matching methods available:

- `cve`: a list of vulnerability identifiers, most commonly CVEs. The assessment will be applied to all vulnerabilities
  listed here.
- `cpe`: a list of CPEs. The assessment will be applied to all vulnerabilities that have a matching CPE on one of the
  affected artifacts.
- `cwe`: a list of CWEs. The assessment will be applied to all vulnerabilities that have a matching CWE.
- `condition`: a [vulnerability filter](vulnerability-filter-format.md) string allowing for specifying custom matching
  conditions. More details on this will be provided below.

The `affects` section is mandatory on `artifact` scope assessments and must contain at least one of the above matching
methods. The matching criteria that lead to activating the assessment also determines which assessment is the most
relevant and therefore which will be picked to have most properties (except the status history) applied to the
vulnerability. More on this in a later section.

### scope

`scope` has two values: `artifact` and `inventory`. If `inventory` is specified, the `affects` section is ignored and
the status file is applied to every vulnerability in the inventory.
This is useful when applying (environmental) CVSS information to an entire inventory at once.

### active

If set to `false`, the assessment entry will be ignored. Defaults to `true`.

### title

Will be displayed alongside the vulnerability identifier in the Vulnerability Assessment Dashboard (HTML) and the
Vulnerability Report (PDF).

### cvssV2 / cvssV3 / cvssV4

The individual CVSS sections can either be set to:

- a CVSS vector string with metrics that will all be applied to the selected vulnerability CVSS vector (using the
  selection policy), creating an assessment (context) CVSS vector, score and severity.
- an object consisting of at least one of the properties:
    - `all`: mimics the behaviour as when only a string is provided, where all metrics are applied no matter what.
    - `lower`: only metrics that lead to a lower/equal CVSS overall score will be applied.
      This is applied on a by-metric method.
      Useful when applying a global `inventory` scope assessment, where a `MAV:A` change is entered and vectors
      with `AV:L` are not meant to be rated as more severe through this change. This property should therefore always be
      used in these global assessments.
    - `higher`: like `lower`, but inverted to apply only higher/equal metrics.

The default CVSS selection policy will consider a vector a context vector as soon as any CVSS modification was present
on any assessment, no matter if a metric was applied (see `lower`/`higher`).
This can be changed to only consider a vector a context vector if truly a metric has been applied by setting the
`assessment` statistics collector from `PRESENCE` (1 if a vector is present, 0 otherwise) to `APPLIED_PARTS_COUNT`
(equals the amount of parts that have been applied).

### reported / accepted

Author and date of report and acceptance. Each of them has two properties:

- `by`: the author of the report/acceptance.
- `date`: the date of the report/acceptance in the format `YYYY-MM-DD` or `YYYY-MM-DD HH:MM:SS`
  (e.g. `2022-01-04 15:30:00`).

### reviewed

A list of advisories matched on the vulnerability that have been reviewed. Reviewing all advisories can be set to be
mandatory by setting the `failOnUnreviewedAdvisories` flag in the Vulnerability Assessment Dashboard, where they will
also be highlighted in green alongside with the comment. Has two properties:

- `id`: the identifier of the advisory that has been reviewed.
- `comment`: a comment on the review.

### history

The status `history` is a list of elements, that each represent a different state in the assessment process.
This is the main part of an assessment entry. Each history entry has the following properties:

- `status`: either `applicable`, `not applicable`, `insignificant` or `void`. Describes the current vulnerability state.
  Is optional, but should always be set on manual assessments (sparingly with good reasoning on automated or global
  ones).
- `date`: the date of the status in the format `YYYY-MM-DD` or `YYYY-MM-DD HH:MM:SS` (e.g. `2022-01-04 15:30:00`), or
  use `${date.current}` for the current timestamp.
- `author`: the author of the status.
- `score`: setting this property will fully overwrite the priority score displayed in the Vulnerability Assessment
  Dashboard.
- free-text fields:
    - `rationale`: a text field for describing the rationale of the current status assessment.
      All CVSS metric modifications should be explained here.
    - `risk`: a text field for describing the risk of the current status assessment.
    - `measures`: a text field for describing the measures that have been taken to mitigate the risk of the current
      status assessment, e.g. for `not applicable` status entries.
      all these fields may contain certain placeholders (variables) that will be replaced with the actual values during
      inventory enrichment. See EX-4 below for examples.
- `labels`: a section that contains two lists:
    - `includes`: activation labels that will cause the status history entry to only activate if any of the `includes`
      labels and none of the `excludes` labels are listed in the `activeLabels` property.
    - `excludes`: activation labels that will cause the status history entry to only activate if any of the `includes`
      labels and none of the `excludes` labels are listed in the `activeLabels` property.
- `priority`: a numerical score that defaults to `0`, which represents a custom metric for changing the order in which
  the assessment entries appear in the list.
  It is recommended to use this with a negative value on automatic assessments, so that manual assessments are
  guaranteed to overwrite them no matter what other factors are set.

### validation

The `validation` section is used to define a set of rules that can be evaluated if the process is configured to do so.
These validations either register as warnings in the inventory or can be set to fail the process if they are not met.

See the [Artifact Correlation](artifact-correlation.md) format for more information or the example EX-5 below. It is
highly recommended to use the JSON Schema for editing this section, especially when using function fields.

## Advisory priority and multiple assessment matching handling

### Status history ordering (compareTo)

The comparison method (ordering logic) for the status history entries is the following, where the first matching
criteria determines the order in which they appear, with the highest one being the effective status that is selected for
that vulnerability. If the answer to the question is Yes, the entry is moved upwards compared to another entry that does
not fulfill that criteria:

1. Is it NOT `inventory` scope?
2. Is it activated (`labels`)?
3. Does it have a status in the `status` field?
4. Does it have a higher priority value?
5. Does it have a more recent date? This metric is usually the one where evaluation stops, since matching multiple
   assessments advances overlapping automatic dates by one millisecond based on several criteria to prevent this match
   to produce the same date on both assessments.
6. Does it have an author?
7. Compare the author alphabetically.
8. Compare the status alphabetically.

### Which assessment entry is picked in the first place?

If multiple assessment entries match on a single vulnerability
(e.g. one with a `cve`, one with a `cpe`, one with a `condition` and one `inventory` scope), the following logic applies
certain data from the entry in a certain order:

- All status `history` entries are applied, no matter what.
  This can also be done in any order, since the effective order is determined by the `compareTo` method described above.
- The rest of the attributes have special handling here.
  The different matching criteria listed in the `affected` section are ordered by priority, meaning the one with the
  highest priority is the most relevant one and will have the rest of its properties except for the `history` applied to
  the vulnerability.
  The priority is determined by the following order:

    1. criteria: `cve`
    2. criteria: `cpe`
    3. criteria: `cwe`
    4. criteria: `condition`
    5. scope: `inventory`

  This means that if an assessment entry with a `cve` and one with a `cpe` match on a vulnerability, the `cve` will be
  picked, since it has a higher priority, but all `history` entries will be applied from both entries.

Understanding both this and the `compareTo` method is crucial for understanding the effective status of a vulnerability.
See the examples below for a better understanding.

## Use-Cases / Examples

All of these examples are valid YAML files that can be used as assessment entries.
They are meant to be _**used in combination with each other**_, each having a different purpose.

### EX-1: Applying assessments for individual vulnerabilities

```yaml
affects:
  cve:
    - CVE-2021-44228
    - CVE-2021-45046
    # cve field can contain wildcards: (* and % = zero or more characters, ? = single character, # = single digit).
    # this for example matches CVE-2022-23305, CVE-2022-23307 (which are matched by cpe below as well).
    # using this is not recommended, since it can lead to unexpected results.
    - CVE-2022-2330?

# default value
scope: artifact
title: Log4j Vulnerabilities

cvssV2:
  all: TD:M/CR:M
  lower: RC:UR/CDP:L
  higher: IR:H/AR:L
cvssV3:
  all: CVSS:3.1/E:H/RL:W/RC:C/CR:H/IR:L/AR:H/MAV:N/MAC:H/MPR:L/MUI:N/MS:X/MC:H/MI:L/MA:H
cvssV4:
  lower: CVSS:4.0/AV:A

reported:
  by: Author
  date: 2022-01-04 15:30:00
accepted:
  by: Author
  date: 2022-01-10

history:
  - status: applicable
    rationale: This vulnerability is applicable to our application.
    risk: "<p>`It poses` the *following risks*:
             <ul>
               <li>Risk number *1*</li>
               <li>Risk number **2**</li>
             </ul>
                        </p>"
    measures: "There `are` **these measures**: ..."
    score: 1.5
    author: Author
    date: 2022-01-14
    labels:
      includes:
        - feature-1
  - status: not applicable
    rationale: This vulnerability is not applicable to our application.
    risk: Poses no risk.
    author: Author
    date: 2022-01-12
    labels:
      includes: [ feature-3, feature-4 ]
      excludes:
        - feature-2
        - feature-1
  - rationale: This vulnerability has no status.

reviewed:
  - id: CERTFR-2020-AVI-350
    comment: This CERTFR avis has been reviewed.
```

### EX-2: CPE / CWE assessments

```yaml
affects:
  cpe:
    # e.g. on CVE-2021-25329
    - cpe:/a:apache:tomcat

cvssV3: CVSS:3.1/MAV:N

history:
  - status: applicable
```

```yaml
affects:
  cwe:
    # Improper Privilege Management
    - CWE-269

history:
  - score: 7.0
    rationale: Improper Privilege Management is an issue that is rated as high in our context.
```

### EX-3: Global assessments

This entry will be overwritten by any other assessment entry that is not a `inventory` scope assessment, since the
`compareTo` method's first matching criteria is the `scope` property.
The same goes for the other properties, where the `inventory` scope assessment is the least relevant one.

This means, `${date.current}` can be used to set the date to the current date without any issues, since the date will
not be the deciding factor when it comes to the effective status of a vulnerability.

```yaml
scope: inventory

cvssV3:
  lower: MAV:A
cvssV2:
  lower: AV:A
cvssV4:
  lower: MAV:A

reported:
  date: 2024-02-02
  by: user

history:
  - date: ${date.current}
    rationale: The application is protected from requests from the internet. Therefore, the attack vector is limited to the local network.
      For this, the Modified Attack Vector (MAV) is set to Adjacent Network (A) for all CVSS versions.
```

### EX-4: Automated conditional assessments

Similar to EX-3, this entry will be overwritten by any other assessment entry that either has a more specific matching
criteria (`condition`) or a higher priority.
The priority is also set to a negative value, so that manual assessments are guaranteed to overwrite this one.

The variables in the `measures` field will be replaced with the actual values during inventory enrichment, in this case
with differently formatted lists of patches and advisors.

```yaml
affects:
  condition: '[attribute "msrc-fixes" is not empty] and [advisor providers contains "MSRC"]'

history:
  - status: applicable
    date: "2024-01-18"
    # this entry will appear below all others, having a priority smaller than the rest (0)
    priority: -1
    measures: |-
      For this vulnerability security patches are available specific to "${msrc.product.name}" (${msrc.product.id}): ${msrc.patch.kblist.csv}.
      ${msrc.patch.kblist.csv}
      ${msrc.patch.kblist.md}
      ${msrc.patch.kblist.html}
      ${advisor.ids}
      ${advisor.providers}
      ${advisor.types}
```

### EX-5: Inventory Validation

```yaml
validation:
  any artifact:
    exists:
      - field: Id
        function: equals
        value: log4j-core-*
      - field: Version
        function: version <=
        value: 2.16.0

  any vulnerability:
    exists:
      - field: CVSS Modified Overall (max)
        function: numeric >
        value: 6.7

  matching artifact:
    not exists:
      - field: Id
        function: equals
        value: log4j-core-*

  matching vulnerability:
    exists:
      - field: Weakness
        function: csv contains
        value: CWE-269
      - field: Product URIs
        function: csv contains
        value: cpe:/a:redis:redis, cpe:/a:redislabs:redis
```
